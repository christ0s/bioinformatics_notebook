<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genome Analyzer Results</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom styles -->
    <style>
        .modal-backdrop {
            opacity: 0.5 !important;
        }
        .btn-close-white {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        .plot-section {
            width: 48%;
        }
        .clickable {
            cursor: pointer;
            text-decoration: underline;
        }
        /* Modal and viewport styles */
        .modal-xl {
            max-width: 90% !important;
        }
        
        .modal-content {
            background-color: #343a40 !important;
        }
        
        .btn-close-white {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        
        /* NGL viewer container styles */
        #viewport {
            position: relative !important;
            width: 100% !important;
            height: 600px !important;
            background-color: white !important;
            overflow: hidden !important;
        }

        /* Loading spinner styles */
        .spinner-border {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
    
    <!-- Required Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/ngl@2.0.0-dev.37/dist/ngl.js"></script>

    <script>
        // Client-side cache for BLAST results
        const blastCache = {};

        // Toggle visibility function
        function toggleVisibility(id) {
            const element = document.getElementById(id);
            element.style.display = element.style.display === "none" ? "block" : "none";
        }

        // BLAST search functions
        function renderBlastResults(index, data) {
            const blastResultsContainer = document.getElementById(`blast-results-${index}`);
            blastResultsContainer.innerHTML = '';
            data.forEach(result => {
                const pdbId = result['Sequence ID'].split('|')[1];
                const resultElement = document.createElement('div');
                resultElement.innerHTML = `
                    <div class="mb-4 p-3 border rounded">
                        <p><strong>Sequence ID:</strong>
                            <a href="#" class="text-warning" onclick="showProteinVisualization(${index}, '${pdbId}')">
                                ${result['Sequence ID']}
                            </a>
                        </p>
                        <p><strong>Description:</strong> ${result['Description']}</p>
                        <p><strong>E-value:</strong> ${result['E-value']}</p>
                        <p><strong>Bit Score:</strong> ${result['Bit Score']}</p>
                        <p><strong>Alignment:</strong><br> <pre class="text-light">${result['Alignment']}</pre></p>
                    </div>
                `;
                blastResultsContainer.appendChild(resultElement);
            });
        }

        function performBlastSearch(index) {
            const selectedProtein = document.querySelector(`input[name="protein_sequence_${index}"]:checked`);
            if (!selectedProtein) {
                alert('Please select a protein sequence for BLAST search.');
                return;
            }
            const proteinSequence = selectedProtein.value;
            const blastResultsContainer = document.getElementById(`blast-results-${index}`);
            
            // Show loading spinner
            blastResultsContainer.innerHTML = '<div class="text-center"><div class="spinner-border text-light" role="status"><span class="sr-only">Loading...</span></div></div>';
            
            // Check cache
            if (blastCache[proteinSequence]) {
                console.log('Using cached results');
                renderBlastResults(index, blastCache[proteinSequence]);
                return;
            }

            fetch('/blast_search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ protein_sequence: proteinSequence })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                blastCache[proteinSequence] = data;
                renderBlastResults(index, data);
            })
            .catch(error => {
                console.error('Error:', error);
                blastResultsContainer.innerHTML = `
                    <div class="alert alert-danger">
                        Error performing BLAST search: ${error.message}
                    </div>
                `;
            });
        }

        // Protein visualization functions
        function visualizeProtein(pdbId, viewportId) {
            console.log(`[DEBUG] Starting visualization for PDB ID: ${pdbId} in viewport: ${viewportId}`);
            
            const viewport = document.getElementById(viewportId);
            if (!viewport) {
                console.error(`[ERROR] Could not find viewport element: ${viewportId}`);
                return;
            }
            
            viewport.innerHTML = '<div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div>';
            
            try {
                // Create NGL Stage
                const stage = new NGL.Stage(viewportId, { backgroundColor: "white" });
                window.addEventListener('resize', () => stage.handleResize(), false);
                
                console.log(`[DEBUG] Loading structure from local server: ${pdbId}`);
                
                // Changed: Add format specification
                stage.loadFile(`/pdb/${pdbId}`, {
                    ext: "pdb",
                    defaultRepresentation: false,
                    firstModelOnly: true
                })
                .then(component => {
                    console.log('[DEBUG] Structure loaded successfully');
                    // Add cartoon representation
                    component.addRepresentation("cartoon", {
                        color: "chainid"
                    });
                    // Add ball and stick for ligands
                    component.addRepresentation("ball+stick", {
                        sele: "hetero and not water",
                        color: "element"
                    });
                    // Center and zoom
                    component.autoView();
                    console.log('[DEBUG] Visualization complete');
                })
                .catch(error => {
                    console.error('[ERROR] Failed to load structure:', error);
                    viewport.innerHTML = `<div class="alert alert-danger">Error loading structure: ${error.message}</div>`;
                });
            } catch (error) {
                console.error('[ERROR] Error creating NGL Stage:', error);
                viewport.innerHTML = `<div class="alert alert-danger">Error creating viewer: ${error.message}</div>`;
            }
        }

        function showProteinVisualization(index, pdbId) {
            console.log(`[DEBUG] Opening modal for PDB ID: ${pdbId}`);
            const modalElement = document.getElementById(`proteinVisualizationModal-${index}`);
            
            if (!modalElement) {
                console.error(`[ERROR] Modal element not found for index: ${index}`);
                return;
            }
            
            const modal = new bootstrap.Modal(modalElement);
            
            // Remove existing event listeners
            modalElement.replaceWith(modalElement.cloneNode(true));
            
            // Get fresh reference after cloning
            const freshModal = document.getElementById(`proteinVisualizationModal-${index}`);
            
            freshModal.addEventListener('shown.bs.modal', function () {
                console.log(`[DEBUG] Modal shown, initializing visualization for ${pdbId}`);
                visualizeProtein(pdbId, `viewport-${index}`);
            });
            
            modal.show();
        }

        // DNA/RNA Modal functions
        function showDNAModal(index, dna) {
            const textArea = document.getElementById(`dnaTextArea-${index}`);
            textArea.value = dna;
            const modal = new bootstrap.Modal(document.getElementById(`dnaModal-${index}`));
            modal.show();
        }

        function showRNAModal(index, rna) {
            const textArea = document.getElementById(`rnaTextArea-${index}`);
            textArea.value = rna;
            const modal = new bootstrap.Modal(document.getElementById(`rnaModal-${index}`));
            modal.show();
        }

        function copyDNA(index) {
            const textArea = document.getElementById(`dnaTextArea-${index}`);
            textArea.select();
            document.execCommand('copy');
            alert('DNA sequence copied to clipboard!');
        }

        function copyRNA(index) {
            const textArea = document.getElementById(`rnaTextArea-${index}`);
            textArea.select();
            document.execCommand('copy');
            alert('RNA sequence copied to clipboard!');
        }

        // Plot Modal function
        function showModal(index) {
            const modal = new bootstrap.Modal(document.getElementById(`plotModal-${index}`));
            modal.show();
        }

        // Initialize tooltips
        document.addEventListener('DOMContentLoaded', function() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
    </script>
</head>
<body class="bg-dark text-light">
  <div class="d-flex">
    <!-- Sidebar Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-secondary flex-column vh-100 p-3 shadow-lg">
      <div class="d-flex flex-column w-100">
        <a class="navbar-brand text-light font-weight-bold" href="#">Genomes SEN</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <div class="navbar-nav flex-column">
            {% for result in results %}
            <div class="nav-item">
              <a class="nav-link text-light" href="#info-{{ loop.index }}">{{ result.id.split('.')[0] }}</a>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid p-4 main-content">
      {% for result in results %}
      {% set res_index = loop.index %}
      <div id="info-{{ res_index }}" class="card bg-secondary text-light p-3 mb-4 shadow-lg info-section">
        <div class="card-body">
          <h3 class="card-title">Sequence ID: {{ result.id }}</h3>
          <p><strong>Genome Name:</strong> {{ result.genome_name }}</p>
          <p>
            <strong>DNA:</strong>
            <span class="dna-text clickable" style="cursor: pointer; text-decoration: underline;" onclick="showDNAModal({{ res_index }}, '{{ result.dna|e }}')">
              {{ result.dna[:50] }}...
            </span>
          </p>
          <p>
            <strong>RNA:</strong>
            <span class="rna-text clickable" style="cursor: pointer; text-decoration: underline;" onclick="showRNAModal({{ res_index }}, '{{ result.rna|e }}')">
              {{ result.rna[:50] }}...
            </span>
          </p>
          <p><strong>Protein:</strong> {{ result.protein[:50] }}...</p>
          <p><strong>GC Content:</strong> {{ result.gc_content }}%</p>
          <p><strong>Total Amino Acids:</strong> {{ result.total_amino_acids }}</p>
          <p onclick="toggleVisibility('amino-acids-{{ res_index }}')" style="cursor: pointer; text-decoration: underline;">
            Show Amino Acid Counts
          </p>
          <ul id="amino-acids-{{ res_index }}" style="display: none;">
            {% for aa, count in result.amino_acid_counts %}
            <li><strong>{{ aa }}:</strong> {{ count }}</li>
            {% endfor %}
          </ul>
          <p>
            <strong data-toggle="tooltip" data-placement="top" title="The top 5 proteins with greater 20 aminoacids">
              Top 5 Protein Sequences:
            </strong>
          </p>
          <fieldset>
            {% for protein in result.top_long_proteins %}
            <div class="form-check">
              <input class="form-check-input" type="radio" 
                     name="protein_sequence_{{ res_index }}" 
                     id="protein_{{ res_index }}_{{ loop.index }}" 
                     value="{{ protein }}">
              <label class="form-check-label text-light" for="protein_{{ res_index }}_{{ loop.index }}">
                {{ protein[:50] }}...
              </label>
            </div>
            {% endfor %}
          </fieldset>
          <button class="btn btn-warning mt-3" onclick="performBlastSearch({{ res_index }})">
            Perform BLAST Search
          </button>
          <div id="blast-results-{{ res_index }}" class="mt-3"></div>
          <button class="btn btn-info mt-3" onclick="showModal({{ res_index }})">
            Show Plots
          </button>
        </div>
      </div>

      <!-- Plot Modal -->
      <div class="modal fade" id="plotModal-{{ res_index }}" tabindex="-1" role="dialog" aria-labelledby="plotModalLabel-{{ res_index }}" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="plotModalLabel-{{ res_index }}">Plots for {{ result.id }}</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body d-flex justify-content-between">
              <div class="plot-section">
                {{ result.nucleotide_distribution|safe }}
              </div>
              <div class="plot-section">
                {{ result.amino_acid_distribution|safe }}
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>

      <!-- DNA Modal -->
      <div class="modal fade" id="dnaModal-{{ res_index }}" tabindex="-1" role="dialog" aria-labelledby="dnaModalLabel-{{ res_index }}" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content bg-secondary text-light">
            <div class="modal-header">
              <h5 class="modal-title" id="dnaModalLabel-{{ res_index }}">Full DNA Sequence for {{ result.id }}</h5>
              <button type="button" class="close text-light" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <textarea id="dnaTextArea-{{ res_index }}" class="form-control" rows="10" readonly></textarea>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-info" onclick="copyDNA({{ res_index }})">Copy DNA</button>
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>

      <!-- RNA Modal -->
      <div class="modal fade" id="rnaModal-{{ res_index }}" tabindex="-1" role="dialog" aria-labelledby="rnaModalLabel-{{ res_index }}" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content bg-secondary text-light">
            <div class="modal-header">
              <h5 class="modal-title" id="rnaModalLabel-{{ res_index }}">Full RNA Sequence for {{ result.id }}</h5>
              <button type="button" class="close text-light" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <textarea id="rnaTextArea-{{ res_index }}" class="form-control" rows="10" readonly></textarea>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-info" onclick="copyRNA({{ res_index }})">Copy RNA</button>
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Protein Visualization Modal -->
      <div class="modal fade" id="proteinVisualizationModal-{{ res_index }}" 
           tabindex="-1" aria-labelledby="proteinVisualizationModalLabel-{{ res_index }}" aria-hidden="true">
        <div class="modal-dialog modal-xl">
          <div class="modal-content bg-dark">
            <div class="modal-header">
              <h5 class="modal-title text-light" id="proteinVisualizationModalLabel-{{ res_index }}">
                3D Protein Structure Viewer
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Important: Set explicit dimensions and background -->
                <div id="viewport-{{ res_index }}" 
                     style="width:100%; height:600px; background-color: white; position: relative;">
                </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</body>
</html>
